---
title: Android 图形系统基础
tags:
- Basis
- Graphics
categories:
- [Graphics]
mathjax: true
---



本文将会对图形系统常见概念作一个简单的介绍和分析。

<!-- more -->



# 1. 计算机图形系统

一个计算机图形系统可以简单分为三个部分：

- 图形输入设备（鼠标、键盘、扫描仪等）
- CPU、GPU
- 图形输出设备（显示器、打印机等）

图像的显示过程可以简单总结为：CPU 负责计算数据，把计算好数据交给 GPU，然后 GPU 会对图形数据进行渲染，渲染完毕之后会数据放置到缓冲区当中，最后显示器负责取出缓冲区中的数据并呈现到屏幕上。



# 2. 帧率

帧率 (Frame rate)，一般是表示显示器上被称为帧的连续图形出现的速率，但是有时候也会用于表示渲染引擎输出帧的速率。单位一般用 fps(frames per second) 表示。



# 3. 刷新率

刷新率 (Refresh rate)，表示基于光栅的显示设备显示新图像的速率。单位一般用 HZ 表示。

例如，一个 60HZ 的显示器，表示显示器可以每秒重新绘图 60 次，绘制一帧画面大约需要 $\frac{1}{60}$ 秒 。

一般来说，显示器的刷新率都是固定的，但现在有一些搭载 G-sync 和 freesync 的显示器可以动态调整自身的刷新率，以此适应显卡输出的速率。



# 4. 逐行扫描

逐行扫描是显示设备显示运动图像的方式。通俗地说，显示器输出一帧画面，是通过电子束按照从左到右，从上到下的顺序进行屏幕扫描，一行一行输出的。



# 5. 画面撕裂

画面撕裂 (Screen tearing)，指的是显示设备在一次画面绘制中展示了来自多个帧信息的错误显示现象。

<img src="https://upload.wikimedia.org/wikipedia/commons/0/03/Tearing_%28simulated%29.jpg" alt="A typical video tearing artifact (simulated image)" style="zoom:30%;" />

## 5.1 原因

画面撕裂本质上是渲染引擎提供帧的速率和显示器刷新率不匹配造成的。

例如，假设现在有一块缓冲区，显卡输出的帧率恒定为 100FPS，而显示器的刷新率恒定为 60HZ，那么会出现以下过程：

1. 在第 $\frac{1}{100}$(0.01) 秒，显卡向缓冲区输出了一帧画面 A；
2. 在第 $\frac{1}{60}$(0.016) 秒，显示器从缓冲区中读取数据并绘制画面 A，这个刷新过程会在第 $\frac{2}{60}$(0.032) 秒完成；
3. 在第 $\frac{2}{100}$(0.02) 秒，显卡向缓冲区输出了一帧画面 B，此时由于只有一块缓冲区，那么画面 A 的数据会被画面 B 的数据覆盖。本来，显示器绘制画面 A 会在第 $\frac{2}{60}$(0.032) 秒完成，但是缓冲区中画面 A 的数据已经被画面 B 的数据覆盖，因此接下来显示器绘制用的是画面 B 的数据。此时，屏幕上会出现了画面 A 的一部分以及画面 B 的一部分，这个现象就是画面撕裂。



# 6. 画面撕裂的解决方法

经过 [小节5.1] 的分析，我们知道，当渲染引擎提供帧的速率和显示器刷新率不匹配时，很容易导致显示器读取到 "脏数据"，从而导致画面撕裂的现象。

显然，这个是数据同步问题。要彻底解决画面撕裂问题，就必须增加一些同步机制。

## 6.1 垂直同步

垂直同步 (Vertical synchronization)，是指在显示器的刷新期间，显卡被禁止修改显示内存的数据，只有当显示器完成当前的刷新周期之后，显卡才可以刷新显示内存的数据。

以此保证显示器在刷新期间，当前显示帧的数据不会被修改，从而避免画面撕裂的问题。

### 6.1.1 **垂直消隐间隔**

垂直消隐间隔 (Vertical Blank Interval)，是指扫描当前帧最后一行的结束时间和扫描下一帧第一行的开始时间两者的时间差。

在开启垂直同步之后，显卡会在此期间刷新缓冲区的数据。

### 6.1.2 影响

#### 6.1.2.1 渲染引擎的帧速率受限

在开启垂直同步之后，由于在显示器的刷新期间显卡不能输出帧数据，所以显卡输出帧的速率会受限于显示器的刷新率。

例如，假设显示器的刷新率是 60HZ，在使用单缓冲区的情况下，显卡输出帧的速率最高只能达到 60FPS。

#### 6.1.2.2 输入延迟

输入延迟 (Input lag)，通常是指一次输入与游戏或显示器对该输入作出反应之间的任何延迟。

假设显示器的刷新率是 60HZ，在开启垂直同步之后，如果在显示器刷新过程中有输入，那么这次输入到显示就可能会有约 16ms 的延迟。

## 6.2 可变刷新率

可变刷新率 (variable refresh rate)，此技术可以使得显示器的刷新率适应显卡输出帧的速率，从而避免画面撕裂，以及减少显示器刷新率不匹配显卡输出帧的速率造成的画面卡顿现象。

### 6.2.1 技术实现

[Nvidia G-Sync](https://en.wikipedia.org/wiki/Nvidia_G-Sync)

[FreeSync](https://en.wikipedia.org/wiki/FreeSync)



# 7. 多重缓冲

使用多重缓冲可以减少画面撕裂，提高工作效率。

## 7.1 双缓冲

双缓冲技术将缓冲区扩展到两块，渲染引擎所有绘制操作输出的数据结果将被存储于特定的内存区域，这块区域被称为 "后缓冲区"，而显示器获取帧数据的内存区域被称为 "前缓冲区"，前缓冲区和后缓冲区是两块不同的内存。

当渲染引擎绘制完成后，后缓冲区的帧数据将被 "复制" 到前缓冲区，事实上这个操作是通过交换表示 "前缓冲区" 的引用和表示 "后缓冲区" 的引用来实现的，因此这个操作可视为瞬间完成。

// TODO: 补充画图





## 



# 参考

[计算机图形学——计算机图形系统及硬件基础](https://www.cnblogs.com/wkfvawl/p/11559508.html)

[Frame rate](https://en.wikipedia.org/wiki/Frame_rate)

[Refresh rate](https://en.wikipedia.org/wiki/Refresh_rate)

[Screen tearing](https://en.wikipedia.org/wiki/Screen_tearing)

[Vertical blanking interval](https://en.wikipedia.org/wiki/Vertical_blanking_interval)

[Input lag](https://en.wikipedia.org/wiki/Input_lag)

[Multiple buffering](https://en.wikipedia.org/wiki/Multiple_buffering#Double_buffering_in_computer_graphics)

